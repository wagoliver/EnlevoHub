// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== CORE SYSTEM ====================

model Tenant {
  id        String   @id @default(uuid())
  name      String
  document  String   @unique // CNPJ
  plan      Plan     @default(FREE)
  settings  Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  users              User[]
  projects           Project[]
  suppliers          Supplier[]
  contractors        Contractor[]
  brokers            Broker[]
  contracts          Contract[]
  materials          Material[]
  bankAccounts       BankAccount[]
  activityTemplates  ActivityTemplate[]
  measurements       Measurement[]

  @@map("tenants")
}

enum Plan {
  FREE
  BASIC
  PRO
  ENTERPRISE
}

model User {
  id        String   @id @default(uuid())
  tenantId  String
  email     String   @unique
  password  String
  name      String
  role      Role     @default(VIEWER)
  permissions Json?
  isActive  Boolean  @default(true)
  lastLogin DateTime?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  tenant            Tenant              @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  auditLogs         AuditLog[]
  projectEvolutions ProjectEvolution[]
  transactions      FinancialTransaction[]
  measurementsReported Measurement[]    @relation("measurementReporter")
  measurementsReviewed Measurement[]    @relation("measurementReviewer")

  @@index([tenantId])
  @@index([email])
  @@map("users")
}

enum Role {
  ADMIN
  MANAGER
  VIEWER
}

model AuditLog {
  id        String   @id @default(uuid())
  userId    String
  action    String
  entity    String
  entityId  String
  changes   Json?
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([entity, entityId])
  @@index([createdAt])
  @@map("audit_logs")
}

// ==================== PROJECTS & UNITS ====================

model Project {
  id              String        @id @default(uuid())
  tenantId        String
  name            String
  description     String?
  address         Json
  status          ProjectStatus @default(PLANNING)
  startDate       DateTime?
  expectedEndDate DateTime?
  actualEndDate   DateTime?
  budget          Decimal       @db.Decimal(15, 2)
  metadata        Json?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  // Relations
  tenant              Tenant                 @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  units               Unit[]
  evolutions          ProjectEvolution[]
  purchaseOrders      PurchaseOrder[]
  financialTransactions FinancialTransaction[]
  contractorProjects  ContractorProject[]
  activities          ProjectActivity[]

  @@index([tenantId])
  @@index([status])
  @@map("projects")
}

enum ProjectStatus {
  PLANNING
  IN_PROGRESS
  PAUSED
  COMPLETED
  CANCELLED
}

model ProjectEvolution {
  id         String   @id @default(uuid())
  projectId  String
  date       DateTime @default(now())
  percentage Decimal  @db.Decimal(5, 2)
  phase      String
  photos     Json?
  notes      String?  @db.Text
  reportedBy String
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relations
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [reportedBy], references: [id])

  @@index([projectId])
  @@index([date])
  @@map("project_evolutions")
}

model Unit {
  id        String     @id @default(uuid())
  projectId String
  code      String
  type      UnitType
  floor     Int?
  area      Decimal    @db.Decimal(10, 2)
  bedrooms  Int?
  bathrooms Int?
  price     Decimal    @db.Decimal(15, 2)
  status    UnitStatus @default(AVAILABLE)
  metadata  Json?
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  // Relations
  project        Project        @relation(fields: [projectId], references: [id], onDelete: Cascade)
  sales          Sale[]
  unitActivities UnitActivity[]

  @@unique([projectId, code])
  @@index([projectId])
  @@index([status])
  @@map("units")
}

enum UnitType {
  APARTMENT
  HOUSE
  COMMERCIAL
  LAND
}

enum UnitStatus {
  AVAILABLE
  RESERVED
  SOLD
  BLOCKED
}

// ==================== SUPPLIERS & MATERIALS ====================

model Supplier {
  id          String         @id @default(uuid())
  tenantId    String
  name        String
  document    String // CNPJ/CPF
  type        SupplierType
  contacts    Json
  rating      Decimal?       @db.Decimal(3, 2)
  isActive    Boolean        @default(true)
  metadata    Json?
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  // Relations
  tenant         Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  purchaseOrders PurchaseOrder[]
  materials      SupplierMaterial[]
  contracts      Contract[]

  @@index([tenantId])
  @@index([document])
  @@map("suppliers")
}

enum SupplierType {
  MATERIALS
  SERVICES
  BOTH
}

model Material {
  id           String   @id @default(uuid())
  tenantId     String
  name         String
  category     String
  unit         String
  currentPrice Decimal  @db.Decimal(10, 2)
  description  String?  @db.Text
  metadata     Json?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  tenant              Tenant               @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  suppliers           SupplierMaterial[]
  purchaseOrderItems  PurchaseOrderItem[]

  @@index([tenantId])
  @@index([category])
  @@map("materials")
}

model SupplierMaterial {
  id         String   @id @default(uuid())
  supplierId String
  materialId String
  price      Decimal  @db.Decimal(10, 2)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relations
  supplier Supplier @relation(fields: [supplierId], references: [id], onDelete: Cascade)
  material Material @relation(fields: [materialId], references: [id], onDelete: Cascade)

  @@unique([supplierId, materialId])
  @@index([supplierId])
  @@index([materialId])
  @@map("supplier_materials")
}

// ==================== PURCHASES ====================

model PurchaseOrder {
  id           String             @id @default(uuid())
  projectId    String
  supplierId   String
  orderNumber  String
  orderDate    DateTime           @default(now())
  deliveryDate DateTime?
  status       PurchaseOrderStatus @default(PENDING)
  totalAmount  Decimal            @db.Decimal(15, 2)
  notes        String?            @db.Text
  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @updatedAt

  // Relations
  project Project             @relation(fields: [projectId], references: [id], onDelete: Cascade)
  supplier Supplier           @relation(fields: [supplierId], references: [id])
  items   PurchaseOrderItem[]

  @@unique([projectId, orderNumber])
  @@index([projectId])
  @@index([supplierId])
  @@index([status])
  @@map("purchase_orders")
}

enum PurchaseOrderStatus {
  PENDING
  APPROVED
  ORDERED
  DELIVERED
  CANCELLED
}

model PurchaseOrderItem {
  id              String   @id @default(uuid())
  purchaseOrderId String
  materialId      String
  quantity        Decimal  @db.Decimal(10, 2)
  unitPrice       Decimal  @db.Decimal(10, 2)
  totalPrice      Decimal  @db.Decimal(15, 2)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  purchaseOrder PurchaseOrder @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)
  material      Material      @relation(fields: [materialId], references: [id])

  @@index([purchaseOrderId])
  @@index([materialId])
  @@map("purchase_order_items")
}

// ==================== CONTRACTORS ====================

model Contractor {
  id          String   @id @default(uuid())
  tenantId    String
  name        String
  document    String // CNPJ/CPF
  specialty   String[]
  teamSize    Int?
  rating      Decimal? @db.Decimal(3, 2)
  contacts    Json
  isActive    Boolean  @default(true)
  metadata    Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  tenant       Tenant              @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  projects     ContractorProject[]
  contracts    Contract[]
  measurements Measurement[]

  @@index([tenantId])
  @@index([document])
  @@map("contractors")
}

model ContractorProject {
  id           String   @id @default(uuid())
  contractorId String
  projectId    String
  startDate    DateTime
  endDate      DateTime?
  role         String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  contractor Contractor @relation(fields: [contractorId], references: [id], onDelete: Cascade)
  project    Project    @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([contractorId, projectId])
  @@index([contractorId])
  @@index([projectId])
  @@map("contractor_projects")
}

// ==================== BROKERS & SALES ====================

model Broker {
  id              String   @id @default(uuid())
  tenantId        String
  name            String
  document        String // CPF
  creci           String?
  contacts        Json
  commissionRate  Decimal  @db.Decimal(5, 2)
  isActive        Boolean  @default(true)
  metadata        Json?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  sales  Sale[]

  @@index([tenantId])
  @@index([document])
  @@map("brokers")
}

model Sale {
  id          String     @id @default(uuid())
  unitId      String
  brokerId    String?
  clientName  String
  clientDocument String
  clientContacts Json
  saleDate    DateTime   @default(now())
  salePrice   Decimal    @db.Decimal(15, 2)
  paymentPlan Json
  contractId  String?
  commission  Decimal    @db.Decimal(15, 2)
  status      SaleStatus @default(PENDING)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  // Relations
  unit     Unit      @relation(fields: [unitId], references: [id], onDelete: Cascade)
  broker   Broker?   @relation(fields: [brokerId], references: [id])
  contract Contract? @relation(fields: [contractId], references: [id])

  @@index([unitId])
  @@index([brokerId])
  @@index([status])
  @@map("sales")
}

enum SaleStatus {
  PENDING
  SIGNED
  PAID
  CANCELLED
}

// ==================== CONTRACTS ====================

model Contract {
  id          String         @id @default(uuid())
  tenantId    String
  type        ContractType
  partyId     String // ID of supplier, contractor, or client
  partyName   String
  startDate   DateTime
  endDate     DateTime?
  value       Decimal        @db.Decimal(15, 2)
  terms       String         @db.Text
  documentUrl String?
  status      ContractStatus @default(ACTIVE)
  metadata    Json?
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  // Relations
  tenant     Tenant      @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  supplier   Supplier?   @relation(fields: [partyId], references: [id], map: "contract_supplier_fkey")
  contractor Contractor? @relation(fields: [partyId], references: [id], map: "contract_contractor_fkey")
  sales      Sale[]

  @@index([tenantId])
  @@index([type])
  @@index([status])
  @@map("contracts")
}

enum ContractType {
  SUPPLIER
  CONTRACTOR
  CLIENT
  BROKER
}

enum ContractStatus {
  DRAFT
  ACTIVE
  SUSPENDED
  EXPIRED
  TERMINATED
}

// ==================== FINANCIAL ====================

model BankAccount {
  id            String   @id @default(uuid())
  tenantId      String
  bankName      String
  accountNumber String
  balance       Decimal  @db.Decimal(15, 2)
  syncEnabled   Boolean  @default(false)
  lastSync      DateTime?
  metadata      Json?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  tenant       Tenant                 @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  transactions FinancialTransaction[]

  @@index([tenantId])
  @@map("bank_accounts")
}

model FinancialTransaction {
  id              String            @id @default(uuid())
  projectId       String?
  bankAccountId   String?
  type            TransactionType
  category        String
  amount          Decimal           @db.Decimal(15, 2)
  date            DateTime          @default(now())
  paymentMethod   String?
  description     String            @db.Text
  attachments     Json?
  status          TransactionStatus @default(PENDING)
  createdBy       String
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  // Relations
  project     Project?     @relation(fields: [projectId], references: [id], onDelete: SetNull)
  bankAccount BankAccount? @relation(fields: [bankAccountId], references: [id])
  user        User         @relation(fields: [createdBy], references: [id])

  @@index([projectId])
  @@index([bankAccountId])
  @@index([type])
  @@index([category])
  @@index([date])
  @@map("financial_transactions")
}

enum TransactionType {
  INCOME
  EXPENSE
}

enum TransactionStatus {
  PENDING
  COMPLETED
  CANCELLED
}

// ==================== ACTIVITIES & MEASUREMENTS ====================

enum ActivityScope {
  ALL_UNITS
  SPECIFIC_UNITS
  GENERAL
}

enum ActivityStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
}

enum MeasurementStatus {
  PENDING
  APPROVED
  REJECTED
}

model ActivityTemplate {
  id          String   @id @default(uuid())
  tenantId    String
  name        String
  description String?  @db.Text
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  tenant Tenant                 @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  items  ActivityTemplateItem[]

  @@index([tenantId])
  @@map("activity_templates")
}

model ActivityTemplateItem {
  id         String  @id @default(uuid())
  templateId String
  name       String
  order      Int
  weight     Decimal @db.Decimal(5, 2) @default(1)

  // Relations
  template ActivityTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)

  @@index([templateId])
  @@map("activity_template_items")
}

model ProjectActivity {
  id        String         @id @default(uuid())
  projectId String
  name      String
  weight    Decimal        @db.Decimal(5, 2) @default(1)
  order     Int
  scope     ActivityScope  @default(ALL_UNITS)
  status    ActivityStatus @default(PENDING)
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt

  // Relations
  project        Project         @relation(fields: [projectId], references: [id], onDelete: Cascade)
  unitActivities UnitActivity[]
  measurements   Measurement[]

  @@index([projectId])
  @@map("project_activities")
}

model UnitActivity {
  id         String         @id @default(uuid())
  activityId String
  unitId     String?
  progress   Decimal        @db.Decimal(5, 2) @default(0)
  status     ActivityStatus @default(PENDING)
  createdAt  DateTime       @default(now())
  updatedAt  DateTime       @updatedAt

  // Relations
  activity     ProjectActivity @relation(fields: [activityId], references: [id], onDelete: Cascade)
  unit         Unit?           @relation(fields: [unitId], references: [id], onDelete: Cascade)
  measurements Measurement[]

  @@unique([activityId, unitId])
  @@index([activityId])
  @@index([unitId])
  @@map("unit_activities")
}

model Measurement {
  id               String            @id @default(uuid())
  tenantId         String
  activityId       String
  unitActivityId   String?
  contractorId     String?
  reportedBy       String
  progress         Decimal           @db.Decimal(5, 2)
  previousProgress Decimal           @db.Decimal(5, 2) @default(0)
  photos           Json?
  notes            String?           @db.Text
  status           MeasurementStatus @default(PENDING)
  reviewedBy       String?
  reviewedAt       DateTime?
  reviewNotes      String?           @db.Text
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt

  // Relations
  tenant       Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  activity     ProjectActivity  @relation(fields: [activityId], references: [id], onDelete: Cascade)
  unitActivity UnitActivity?    @relation(fields: [unitActivityId], references: [id], onDelete: SetNull)
  contractor   Contractor?      @relation(fields: [contractorId], references: [id], onDelete: SetNull)
  reporter     User             @relation(fields: [reportedBy], references: [id], name: "measurementReporter")
  reviewer     User?            @relation(fields: [reviewedBy], references: [id], name: "measurementReviewer")

  @@index([activityId])
  @@index([unitActivityId])
  @@index([status])
  @@index([contractorId])
  @@index([tenantId])
  @@map("measurements")
}
